version: v1.0
name: Go with PostgreSQL

agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2204

blocks:
  - name: Test
    task:
      prologue:
        commands:
          - checkout
          - sem-version go 1.20
          - export GO111MODULE=on
          - export GOPATH=~/go
          - export PATH=/home/semaphore/go/bin:$PATH
          - sem-service start postgres
          - sleep 5  # wait for PostgreSQL to be ready
          - psql -h 127.0.0.1 -U postgres -c "CREATE DATABASE testdb;" || true
          - export DATABASE_URL=postgres://postgres@localhost:5432/testdb?sslmode=disable
      jobs:
        - name: go test
          commands:
            - go get ./...
            - go test ./...
            - go build -v .
